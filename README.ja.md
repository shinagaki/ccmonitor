# ccmonitor

Claude Code の使用パターンを時系列分析するコマンドラインツール。Linux の SAR コマンドのように Claude Code セッションを監視します。

> **📢 リポジトリ名変更のお知らせ**: このプロジェクトは以前 `claude-usage-monitor` という名前でしたが、簡潔にするため `ccmonitor` に変更されました。ブックマークやローカルリポジトリの URL を更新してください。

## 機能

- 📊 **時間別使用量レポート**: 入力/出力トークンとコストを時間別に追跡
- 🔄 **ローリングウィンドウ監視**: Claude Code Pro の$10/5 時間制限をリアルタイム監視
- 🎯 **正確なコスト計算**: キャッシュトークンを含む Claude Sonnet 4 の精密な料金計算
- 📈 **進捗の可視化**: 使用量制限に対するカラーコード付きプログレスバー
- ⚡ **自動データ収集**: 最新の Claude Code ログを自動スキャン・処理
- 🔍 **柔軟なフィルタリング**: 時間範囲フィルタリングと tail オプション

## クイックスタート

### 前提条件

- [Bun ランタイム](https://bun.sh/)がインストール済み
- Claude Code がインストールされ使用済み（`~/.claude/projects/`にログが生成される）

### インストール

1. リポジトリをクローン：

```bash
git clone https://github.com/shinagaki/ccmonitor.git
cd ccmonitor
chmod +x ccmonitor.ts
```

2. または直接ダウンロード：

```bash
curl -O https://raw.githubusercontent.com/shinagaki/ccmonitor/main/ccmonitor.ts
chmod +x ccmonitor.ts
```

### 基本的な使用方法

```bash
# 時間別使用量レポートを表示
./ccmonitor report

# Pro制限の5時間ローリング使用量を監視
./ccmonitor rolling
```

## 使用例

### 時間別レポート

```bash
# 基本的な時間別レポート
./ccmonitor report

# 直近24時間のみ
./ccmonitor report --tail 24

# 特定の時間範囲
./ccmonitor report --since "2025-06-20 09:00" --until "2025-06-20 18:00"

# スクリプト用JSON出力
./ccmonitor report --json

# ゼロ使用量を含む全時間表示
./ccmonitor report --full
```

### ローリング使用量監視

```bash
# Pro使用量制限の監視（5時間ローリングウィンドウ）
./ccmonitor rolling

# レポートにローリングビューを含める
./ccmonitor report --rolling
```

## 出力の理解

### 時間別レポート

```
 ╭─────────────────────────────────────────╮
 │                                         │
 │     ccmonitor - Hourly Usage Report     │
 │                                         │
 ╰─────────────────────────────────────────╯

┌──────────────────┬──────────────┬──────────────┬──────────────┬────────────┐
│ Hour             │        Input │       Output │        Total │ Cost (USD) │
├──────────────────┼──────────────┼──────────────┼──────────────┼────────────┤
│ 2025-06-20 14:00 │        1,234 │        5,678 │        6,912 │      $0.45 │
│ 2025-06-20 15:00 │        2,345 │        6,789 │        9,134 │      $0.67 │
│ 2025-06-20 16:00 │        3,456 │        7,890 │       11,346 │      $0.89 │
└──────────────────┴──────────────┴──────────────┴──────────────┴────────────┘
│ Total            │        7,035 │       20,357 │       27,392 │      $2.01 │
└──────────────────┴──────────────┴──────────────┴──────────────┴────────────┘
```

### ローリング使用量モニター

```
╭───────────────────────────────────────────╮
│                                           │
│    ccmonitor - Limit Monitor (5-Hour)     │
│                                           │
╰───────────────────────────────────────────╯

┌──────────────────┬───────────┬───────────┬───────────────┐
│ Current Hour     │ Hour Cost │5-Hour Cost│ Limit Progress│
├──────────────────┼───────────┼───────────┼───────────────┤
│ 2025-06-20 14:00 │     $0.45 │     $2.34 │  23.0% ██░░░░░░│
│ 2025-06-20 15:00 │     $0.67 │     $3.12 │  31.0% ███░░░░░│
│ 2025-06-20 16:00 │     $1.23 │     $8.45 │  84.0% ███████░│
│ 2025-06-20 17:00 │     $0.89 │     $9.12 │  91.0% ████████│
└──────────────────┴───────────┴───────────┴───────────────┘

📊 Claude Code Pro制限:
   • コスト制限: 5時間ウィンドウあたり$10.00
   • 時間ウィンドウ: ローリング5時間期間
   • 色分け: 緑（安全）| 黄（注意）| 赤（危険）
```

- **緑のバー**: $10 制限の 0-59%（安全）
- **黄色のバー**: 制限の 60-79%（注意）
- **赤のバー**: 制限の 80%以上（危険）
- **警告**: 80%で ⚠️ HIGH USAGE、90%で 🚨 OVER LIMIT

## データソース

ツールが自動処理するデータ：

- **Claude Code ログ**: `~/.claude/projects/*/`の JSONL ファイル
- **集約データ**: `~/.ccmonitor/usage-log.jsonl`に保存
- **重複排除**: メッセージ ID を使用して同じメッセージの重複カウントを防止

## コスト計算

Claude Sonnet 4 の正確な料金：

- **入力トークン**: 1K トークンあたり$0.003
- **出力トークン**: 1K トークンあたり$0.015
- **キャッシュ作成**: 1K トークンあたり$0.0037
- **キャッシュ読み取り**: 1K トークンあたり$0.0003

## コマンドリファレンス

### グローバルオプション

- `--help`: ヘルプ情報を表示
- `--version`: バージョン情報を表示

### report コマンド

```bash
./ccmonitor report [オプション]
```

**オプション:**

- `--since <日時>`: 開始時刻（例: "2025-06-20 09:00"）
- `--until <日時>`: 終了時刻（例: "2025-06-20 18:00"）
- `--tail <時間数>`: 直近 N 時間のみ表示
- `--rolling`: ローリング使用量ビューを含める
- `--full`: ゼロ使用量を含む全時間表示
- `--json`: JSON 形式で出力

### rolling コマンド

```bash
./ccmonitor rolling [オプション]
```

**オプション:**

- `--tail <時間数>`: 直近 N 時間のみ表示
- `--full`: ゼロ使用量を含む全時間表示
- `--json`: JSON 形式で出力

## Pro 使用量制限

Claude Code Pro には 5 時間ローリングウィンドウあたり$10 の支出制限があります。ローリングモニターの用途：

- ⚠️ **制限到達前の追跡** - 制限に達する前に警告
- 📊 **使用パターンの可視化** - 一日を通じた使用状況
- 🚨 **アラート取得** - 80%（HIGH USAGE）と 90%（OVER LIMIT）でアラート
- ⏰ **使用計画** - ローリングウィンドウを考慮した使用計画

## トラブルシューティング

### よくある問題

**"No Claude Code data found"**

- Claude Code がインストールされ使用されていることを確認
- `~/.claude/projects/`が存在し JSONL ファイルが含まれていることを確認
- ログファイルの読み取り権限を確認

**"Bun command not found"**

- Bun をインストール: `curl -fsSL https://bun.sh/install | bash`
- ターミナルを再起動するかシェルプロファイルをリロード

**不正確な使用量データ**

- ツールはメッセージ ID を使用して自動的にエントリを重複排除
- 重複が見つかった場合はバグとして報告してください

**旧バージョンからの移行**

- 以前に`claude-usage-monitor.ts`を使用していた場合は`ccmonitor.ts`にリネーム
- 旧集約データは`~/.claude-usage-monitor/`に保存されていますが、ccmonitor は`~/.ccmonitor/`を使用
- 移行オプション:
  - **クイック移行**: `mv ~/.claude-usage-monitor ~/.ccmonitor`（集約データを保持）
  - **フレッシュスタート**: 旧ディレクトリを削除して Claude Code ログから再構築
- 移行後は`~/.claude-usage-monitor/`を安全に削除可能（データを移動した場合）
- **注意**: 集約データは使用量要約のみを含み、元の Claude Code ログではないため、再構築は常に可能

### ヘルプの取得

```bash
# 詳細ヘルプを表示
./ccmonitor --help

# バージョンを確認
./ccmonitor --version
```

## 技術詳細

### アーキテクチャ

- **単一ファイル**: Bun ランタイムを使用したピュア TypeScript
- **データ処理**: 重複排除機能付き効率的な JSONL 解析
- **ストレージ**: `~/.ccmonitor/`でのローカル集約
- **表示**: カラーコーディング付きターミナル最適化フォーマット

### パフォーマンス

- 数千のログエントリを効率的に処理
- 自動増分更新（新しいデータのみ処理）
- 最小限のメモリ使用量

## コントリビューティング

1. リポジトリをフォーク
2. フィーチャーブランチを作成: `git checkout -b feature-name`
3. 変更を加える
4. 自分の Claude Code データで十分にテスト
5. プルリクエストを提出

## ライセンス

MIT License - 詳細は[LICENSE](LICENSE)ファイルを参照。

---

**注意**: このツールは非公式で Anthropic とは関連がありません。ローカルに保存された Claude Code ログを分析し、外部にデータを送信することはありません。
